<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DomainUserRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dc-con-app</a> &gt; <a href="index.source.html" class="el_package">org.bremersee.dccon.repository</a> &gt; <span class="el_source">DomainUserRepositoryImpl.java</span></div><h1>DomainUserRepositoryImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.bremersee.dccon.repository;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Stream;
import javax.validation.constraints.NotNull;
import lombok.extern.slf4j.Slf4j;
import org.bremersee.data.ldaptive.LdaptiveEntryMapper;
import org.bremersee.data.ldaptive.LdaptiveTemplate;
import org.bremersee.dccon.config.DomainControllerProperties;
import org.bremersee.dccon.model.DomainUser;
import org.bremersee.dccon.repository.cli.CommandExecutor;
import org.bremersee.dccon.repository.cli.CommandExecutorResponse;
import org.bremersee.dccon.repository.cli.CommandExecutorResponseValidator;
import org.bremersee.dccon.repository.ldap.DomainUserLdapMapper;
import org.bremersee.exception.ServiceException;
import org.ldaptive.SearchFilter;
import org.ldaptive.SearchRequest;
import org.springframework.context.annotation.Profile;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

/**
 * The domain user repository.
 *
 * @author Christian Bremer
 */
@Profile(&quot;ldap&quot;)
@Component(&quot;domainUserRepository&quot;)
<span class="nc" id="L47">@Slf4j</span>
public class DomainUserRepositoryImpl extends AbstractRepository implements DomainUserRepository {

  private LdaptiveEntryMapper&lt;DomainUser&gt; domainUserLdapMapper;

  /**
   * Instantiates a new domain user repository.
   *
   * @param properties   the properties
   * @param ldapTemplate the ldap template
   */
  public DomainUserRepositoryImpl(
      DomainControllerProperties properties,
      LdaptiveTemplate ldapTemplate) {
<span class="nc" id="L61">    super(properties, ldapTemplate);</span>
<span class="nc" id="L62">    domainUserLdapMapper = new DomainUserLdapMapper(properties);</span>
<span class="nc" id="L63">  }</span>

  /**
   * Sets domain user ldap mapper.
   *
   * @param domainUserLdapMapper the domain user ldap mapper
   */
  @SuppressWarnings(&quot;unused&quot;)
  public void setDomainUserLdapMapper(
      LdaptiveEntryMapper&lt;DomainUser&gt; domainUserLdapMapper) {
<span class="nc bnc" id="L73" title="All 2 branches missed.">    if (domainUserLdapMapper != null) {</span>
<span class="nc" id="L74">      this.domainUserLdapMapper = domainUserLdapMapper;</span>
    }
<span class="nc" id="L76">  }</span>

  @Override
  public Stream&lt;DomainUser&gt; findAll() {
<span class="nc" id="L80">    final SearchRequest searchRequest = new SearchRequest(</span>
<span class="nc" id="L81">        getProperties().getUserBaseDn(),</span>
<span class="nc" id="L82">        new SearchFilter(getProperties().getUserFindAllFilter()));</span>
<span class="nc" id="L83">    searchRequest.setSearchScope(getProperties().getUserFindAllSearchScope());</span>
<span class="nc" id="L84">    searchRequest.setBinaryAttributes(&quot;jpegPhoto&quot;);</span>
<span class="nc" id="L85">    return getLdapTemplate().findAll(searchRequest, domainUserLdapMapper);</span>
  }

  @Override
  public Optional&lt;DomainUser&gt; findOne(@NotNull String userName) {
<span class="nc" id="L90">    final SearchFilter searchFilter = new SearchFilter(getProperties().getUserFindOneFilter());</span>
<span class="nc" id="L91">    searchFilter.setParameter(0, userName);</span>
<span class="nc" id="L92">    final SearchRequest searchRequest = new SearchRequest(</span>
<span class="nc" id="L93">        getProperties().getUserBaseDn(),</span>
        searchFilter);
<span class="nc" id="L95">    searchRequest.setSearchScope(getProperties().getUserFindOneSearchScope());</span>
<span class="nc" id="L96">    searchRequest.setBinaryAttributes(&quot;jpegPhoto&quot;);</span>
<span class="nc" id="L97">    return getLdapTemplate().findOne(searchRequest, domainUserLdapMapper);</span>
  }

  @Override
  public boolean exists(@NotNull String userName) {
<span class="nc" id="L102">    return getLdapTemplate()</span>
<span class="nc" id="L103">        .exists(DomainUser.builder().userName(userName).build(), domainUserLdapMapper);</span>
  }

  @Override
  public DomainUser save(@NotNull DomainUser domainUser) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (!exists(domainUser.getUserName())) {</span>
<span class="nc" id="L109">      kinit();</span>
<span class="nc" id="L110">      final List&lt;String&gt; commands = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L111">      sudo(commands);</span>
<span class="nc" id="L112">      commands.add(getProperties().getSambaToolBinary());</span>
<span class="nc" id="L113">      commands.add(&quot;user&quot;);</span>
<span class="nc" id="L114">      commands.add(&quot;create&quot;);</span>
<span class="nc" id="L115">      commands.add(domainUser.getUserName());</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">      if (StringUtils.hasText(domainUser.getPassword())) {</span>
<span class="nc" id="L117">        commands.add(&quot;'&quot; + domainUser.getPassword() + &quot;'&quot;);</span>
      } else {
<span class="nc" id="L119">        commands.add(&quot;--random-password&quot;);</span>
      }
<span class="nc" id="L121">      commands.add(&quot;--use-username-as-cn&quot;);</span>
<span class="nc" id="L122">      auth(commands);</span>

<span class="nc" id="L124">      CommandExecutor.exec(</span>
          commands,
          null,
<span class="nc" id="L127">          getProperties().getSambaToolExecDir(),</span>
          (CommandExecutorResponseValidator) response -&gt; {
<span class="nc" id="L129">            final String err = response.stderrToOneLine();</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">            if (err.startsWith(&quot;ERROR:&quot;) &amp;&amp; err.contains(&quot;check_password_restrictions&quot;)) {</span>
<span class="nc" id="L131">              throw ServiceException.badRequest(</span>
                  &quot;msg=[The password does not meet the complexity criteria!] userName=[&quot;
<span class="nc" id="L133">                      + domainUser.getUserName() + &quot;]&quot;,</span>
                  &quot;check_password_restrictions&quot;);
            }
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (!exists(domainUser.getUserName())) {</span>
<span class="nc" id="L137">              throw ServiceException.internalServerError(&quot;msg=[Saving user failed.] userName=[&quot;</span>
<span class="nc" id="L138">                  + domainUser.getUserName() + &quot;] &quot;</span>
<span class="nc" id="L139">                  + CommandExecutorResponse.toExceptionMessage(response),</span>
                  &quot;org.bremersee:dc-con-app:216e1246-b464-48f1-ac88-20e8461dea1e&quot;);
            }
<span class="nc" id="L142">          });</span>
    }
<span class="nc" id="L144">    return getLdapTemplate().save(domainUser, domainUserLdapMapper);</span>
  }

  @Override
  public void savePassword(@NotNull String userName, @NotNull String newPassword) {
<span class="nc" id="L149">    kinit();</span>
<span class="nc" id="L150">    final List&lt;String&gt; commands = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L151">    sudo(commands);</span>
<span class="nc" id="L152">    commands.add(getProperties().getSambaToolBinary());</span>
<span class="nc" id="L153">    commands.add(&quot;user&quot;);</span>
<span class="nc" id="L154">    commands.add(&quot;setpassword&quot;);</span>
<span class="nc" id="L155">    commands.add(userName);</span>
<span class="nc" id="L156">    commands.add(&quot;--newpassword='&quot; + newPassword + &quot;'&quot;); // works</span>
<span class="nc" id="L157">    auth(commands);</span>
<span class="nc" id="L158">    CommandExecutor.exec(</span>
        commands,
        null,
<span class="nc" id="L161">        getProperties().getSambaToolExecDir(),</span>
        (CommandExecutorResponseValidator) response -&gt; {
<span class="nc" id="L163">          final String err = response.stderrToOneLine();</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">          if (err.startsWith(&quot;ERROR:&quot;) &amp;&amp; err.contains(&quot;check_password_restrictions&quot;)) {</span>
<span class="nc" id="L165">            throw ServiceException.badRequest(</span>
                &quot;msg=[The password does not meet the complexity criteria!] userName=[&quot;
                    + userName + &quot;]&quot;,
                &quot;check_password_restrictions&quot;);
<span class="nc bnc" id="L169" title="All 2 branches missed.">          } else if (StringUtils.hasText(err)) {</span>
<span class="nc" id="L170">            throw ServiceException.internalServerError(</span>
                &quot;msg=[Setting new password failed.] userName=[&quot; + userName + &quot;] &quot;
<span class="nc" id="L172">                    + CommandExecutorResponse.toExceptionMessage(response),</span>
                &quot;org.bremersee:dc-con-app:abc34c93-920e-4600-b5b4-3ce215a9fdeb&quot;);
          }
<span class="nc" id="L175">        });</span>
<span class="nc" id="L176">  }</span>

  @Override
  public boolean delete(@NotNull String userName) {

<span class="nc bnc" id="L181" title="All 2 branches missed.">    if (exists(userName)) {</span>
<span class="nc" id="L182">      kinit();</span>
<span class="nc" id="L183">      final List&lt;String&gt; commands = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L184">      sudo(commands);</span>
<span class="nc" id="L185">      commands.add(getProperties().getSambaToolBinary());</span>
<span class="nc" id="L186">      commands.add(&quot;user&quot;);</span>
<span class="nc" id="L187">      commands.add(&quot;delete&quot;);</span>
<span class="nc" id="L188">      commands.add(userName);</span>
<span class="nc" id="L189">      auth(commands);</span>
<span class="nc" id="L190">      CommandExecutor.exec(</span>
          commands,
          null,
<span class="nc" id="L193">          getProperties().getSambaToolExecDir(),</span>
          (CommandExecutorResponseValidator) response -&gt; {
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (exists(userName)) {</span>
<span class="nc" id="L196">              throw ServiceException.internalServerError(</span>
                  &quot;msg=[Deleting user failed.] userName=[&quot; + userName + &quot;] &quot;
<span class="nc" id="L198">                      + CommandExecutorResponse.toExceptionMessage(response));</span>
            }
<span class="nc" id="L200">          });</span>
<span class="nc" id="L201">      return true;</span>
    }
<span class="nc" id="L203">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>